if (self.CavalryLogger) { CavalryLogger.start_js(["lv\/dB"]); }

__d('MInitJewelCounts',['Stratcom'],(function a(b,c,d,e,f,g,h){'use strict';var i=[],j=false;function k(n){h.invoke('m:jewels:init-counts',null,n);}function l(n){k(n);if(!j)i.push(n);}function m(){if(j)return;j=true;var n=i.splice(0,i.length);n.forEach(function(o){k(o);});}f.exports={main:l,replayMissedEvents:m};}),null);
__d('Popover',['setTimeoutAcrossTransitions','CSS','DOM','MAria','MViewport','Stratcom','Vector','$','eventsMixinDeprecated'],(function a(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=40;function r(s){'use strict';var t=s.flyout;this.flyout=typeof t=='string'?o(t):t;this.content=j.scry(this.flyout,'div','flyout-content')[0];this.options=s;this._onOrientationChange=this._reposition.bind(this);this.jewelRedirect=s.jewelRedirect;i.conditionClass(this.flyout,'popover_flyout',true);var u=s.button;if(u){this.button=typeof u=='string'?o(u):u;this.buttonClickListener=j.listen(this.button,'click',null,this._openHandler.bind(this));this.button.setAttribute('role','button');k.setupPopup(this.button,this.flyout);}var v=s.flyoutAnchor;if(v){this.flyoutAnchor=typeof v=='string'?o(v):v;}else this.flyoutAnchor=this.button;if(this.options.flyoutFromRoot)this.flyoutClickListener=j.listen(this.flyout,'click',null,this._openHandler.bind(this));if(this.options.touchstart_callback)this.flyoutTouchStartListener=j.listen(this.flyout,'touchstart',null,this._touchStartHandler.bind(this));if(this.options.touchmove_callback)this.flyoutTouchMoveListener=j.listen(this.flyout,'touchmove',null,this._touchMoveHandler.bind(this));if(this.options.touchend_callback)this.flyoutTouchEndListener=j.listen(this.flyout,'touchend',null,this._touchEndHandler.bind(this));r._instances[this.flyout.id]=this;}r.prototype.isOpen=function(){'use strict';return !!this._isOpen;};r.prototype.open=function(){'use strict';if(this.isOpen())return;if(r._activePopover)r._activePopover.close();r._activePopover=this;this._isOpen=true;this.constraint=null;if(!this.jewelRedirect)i.conditionClass(this.flyout,'popover_hidden',false);if(this.options.flyoutFromRoot)this._absolutePositionFlyout();this._position();if(!this.options.heightConstraint){i.conditionClass(document.body,'disableClicks',true);this.globalListener=m.listenCapture('click',null,this._closeHandler.bind(this));}window.addEventListener('orientationchange',this._onOrientationChange,false);k.showPopup(this.button,this.flyout);if(this.options.ensureVisible){var s=l.getScrollTop(),t=this._getElementPosition(this.flyout).y,u=t+this.flyout.offsetHeight,v=u-(s+l.getUseableHeight());if(v>0){var w=Math.min(v,Math.max(t-s-q,0));l.scrollTo(0,s+w);}}this.invoke('open');};r.prototype.close=function(s){'use strict';if(!this.isOpen())return;r._activePopover=null;this._isOpen=false;i.conditionClass(this.flyout,'popover_hidden',true);if(this.options.flyoutFromRoot){this.flyoutParent.appendChild(this.flyout);delete this.flyoutParent;}h(function(){i.conditionClass(document.body,'disableClicks',false);}.bind(this),400);this.globalListener&&this.globalListener.remove();window.removeEventListener('orientationchange',this._onOrientationChange,false);this._releaseConstraint();k.hidePopup(this.button,this.flyout);if(!s)this.invoke('close');};r.prototype.clear=function(){'use strict';this.globalListener&&this.globalListener.remove();this.buttonClickListener&&this.buttonClickListener.remove();this.flyoutClickListener&&this.flyoutClickListener.remove();this.flyoutTouchStartListener&&this.flyoutTouchStartListener.remove();this.flyoutTouchMoveListener&&this.flyoutTouchMoveListener.remove();this.flyoutTouchEndListener&&this.flyoutTouchEndListener.remove();delete r._instances[this.flyout.id];};r.prototype.refreshConstraints=function(){'use strict';if(!this._isOpen)return false;var s=this.flyout;this._releaseConstraint();if(this.options.heightConstraint){s.style.minHeight=l.getUseableHeight()+'px';this.constraint=l.addHeightConstraint(n.getDim(this.content).y+this._getElementPosition(s).y);}else this.constraint=l.addMinHeightConstraint(n.getDim(s).y+this._getElementPosition(s).y+r._MARGIN);};r.prototype._getTouchPoint=function(event){'use strict';var s=event.getRawEvent().targetTouches[0],t={x:s?s.screenX:0,y:s?s.screenY:0};return t;};r.prototype._touchStartHandler=function(event){'use strict';this.options.touchstart_callback(this._getTouchPoint(event));};r.prototype._touchMoveHandler=function(event){'use strict';if(this.isOpen())this.options.touchmove_callback(this._getTouchPoint(event));};r.prototype._touchEndHandler=function(event){'use strict';this.options.touchend_callback(this._getTouchPoint(event));};r.prototype._openHandler=function(event){'use strict';if(!this.jewelRedirect)event.prevent();var s=this.isOpen();if(s&&!this.options.preventClose){this.close();}else if(!s){var t=j.scry(document,'input');for(var u=0;u<t.length;u++)t[u].blur();this.open();}};r.prototype._closeHandler=function(event){'use strict';if(!event.getNode('popover'))this.close();};r.prototype._getElementPosition=function(s){'use strict';var t=s.offsetLeft,u=s.offsetTop;s=s.offsetParent;while(s&&s!==document.documentElement){t+=s.offsetLeft;u+=s.offsetTop;var v=window.getComputedStyle(s);t+=parseInt(v.getPropertyValue('border-left-width').slice(0,-2),10);u+=parseInt(v.getPropertyValue('border-top-width').slice(0,-2),10);s=s.offsetParent;}return new n(t,u);};r.prototype._absolutePositionFlyout=function(){'use strict';this.flyoutParent=this.flyout.parentNode;o('root').appendChild(this.flyout);var s=this._getElementPosition(this.flyout.parentNode),t=this._getElementPosition(this.flyoutAnchor),u=n.getDim(this.flyoutAnchor),v=t.y-s.y+u.y;this.flyout.style.position='absolute';this.flyout.style.top=v+'px';};r.prototype._position=function(){'use strict';var s=this.flyout;if(this.flyoutAnchor&&this.options.positionNub){var t=this._getElementPosition(this.flyoutAnchor),u=j.find(this.flyout,'*','nub'),v=n.getDim(u).x,w=n.getDim(this.flyoutAnchor).x,x=this._getElementPosition(s);new n(t.x-x.x+(w-v)/2,0).setPos(u);}this.refreshConstraints();};r.prototype._reposition=function(){'use strict';h(this._position.bind(this),0);};r.prototype._releaseConstraint=function(){'use strict';if(this.constraint){this.constraint.release();this.constraint=null;}};r.getInstance=function(s){'use strict';return r._instances[s];};r.clearAll=function(){'use strict';for(var s=0;s<r._instances.length;s++)r._instances[s].clear();};p(r,['open','close']);Object.assign(r,{_activePopover:null,_MARGIN:40,_instances:{}});f.exports=r;}),null);
__d('MJewel',['CSS','DOM','MHistory','MJSEnvironment','MLogState','MTabbable','MViewport','Popover','Stratcom','$','eventsMixinDeprecated','intlNumUtils','setTimeoutAcrossTransitions'],(function a(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){var u=10;function v(w,x){'use strict';this._sigil=w;this.options=x||{};this._jewelNode=q(v.JEWEL_NAV_NODE_ID);this._softState=x.softState||'jewel='+v.nextID++;this._duringInit=false;this.jewelRedirect=x.jewelRedirect;this._createPopover();if(!this.jewelRedirect)p.listen('m:history:change',null,function(event){if(event.getData().soft===this._softState){this._popover&&this._popover.open();}else this._popover&&this._popover.close();}.bind(this));}v.prototype.isInitialized=function(){'use strict';var w=this.options.contentsSigil||'contents';return !!i.scry(this._jewelNode,'*',w)[0];};v.prototype._getJewelElement=function(){'use strict';return i.find(this._jewelNode,'div',this._sigil);};v.prototype._getCountElement=function(){'use strict';return i.find(this._getJewelElement(),'span','count');};v.prototype._getContentsElement=function(){'use strict';var w=this.options.contentsSigil||'contents';return i.find(this._getJewelElement(),'*',w);};v.prototype._getFlyoutElement=function(){'use strict';return i.find(this._getJewelElement(),'*','flyout');};v.prototype.getCount=function(){'use strict';return this._count;};v.prototype.setDuringInit=function(w){'use strict';this._duringInit=w;};v.prototype._updateCountElement=function(){'use strict';var w=this._getJewelCount();i.setContent(this._getCountElement(),s.formatNumberWithThousandDelimiters(w||0));var x=this._getJewelElement(),y=this._count>0;h.conditionClass(x,'noCount',!y);h.conditionClass(x,'hasCount',y);};v.prototype.setCount=function(w){'use strict';if(w<0)return;this._count=w;this._updateCountElement();};v.prototype.setHeaderText=function(w,x){'use strict';if(!w||!x)return;var y=this._getFlyoutElement();if(!y)return;var z=i.scry(y,'*',w)[0];if(!z)return;var aa=z.cloneNode(true);aa.innerText=x;i.replace(z,aa);};v.prototype.handleViewedContent=function(){'use strict';if(this.getCount()>0&&this.isInitialized()){this.setCount(0);this.invoke('cleared');}else this.invoke('jewel_click');};v.prototype.setMenuContent=function(w){'use strict';i.setContent(this._getFlyoutElement(),w);if(this.isOpen())this.handleViewedContent();};v.prototype.prependMenuContent=function(w){'use strict';i.prependContent(this._getContentsElement(),w);};v.prototype.removeMenuContent=function(w){'use strict';var x=document.getElementById(w);if(x)i.remove(x);};v.prototype.updateMenuColor=function(w,x,y){'use strict';y?t(this._updateMenuColor.bind(this,w,x),v.MARK_READ_DELAY):this._updateMenuColor(w,x);};v.prototype._updateMenuColor=function(w,x){'use strict';var y=document.getElementById(w);if(y){h.conditionClass(y,v.M_AREA_LIGHTBLUE,!x);h.conditionClass(y,v.M_AREA_WHITE,x);}};v.prototype._createPopover=function(){'use strict';var w=this._getJewelElement(),x=i.find(w,'div','flyout');this._popover=new o({button:i.find(w,'*','icon'),flyout:x,ensureVisible:false,heightConstraint:true,preventClose:true,jewelRedirect:this.jewelRedirect});this._onOpenListener=this._popover.listen('open',this._onOpen.bind(this));this._onCloseListener=this._popover.listen('close',this._onClose.bind(this));this._popoverClickListener=i.listen(x,'click',null,this._onPopoverClick.bind(this));if(k.IS_ANDROID&&k.GET_OS_VERSION>=4)this._scrollAreaNode=i.scry(x,'div','scroll-area')[0];};v.prototype.clear=function(){'use strict';this._onOpenListener&&this._onOpenListener.remove();this._onCloseListener&&this._onCloseListener.remove();this._popoverClickListener&&this._popoverClickListener.remove();this._popoverTouchStartListener&&this._popoverTouchStartListener.remove();this._touchMoveListener&&this._touchMoveListener.remove();this._touchStartListener&&this._touchStartListener.remove();this._popover&&this._popover.clear();};v.prototype._onPopoverClick=function(event){'use strict';l.updateLink(event,this.options.pos);this.options.clickCallback&&this.options.clickCallback(event);};v.prototype._onPopoverTouchStart=function(event){'use strict';event.kill();};v.prototype._getJewelCount=function(){'use strict';if(this._count>0){return this._count;}else return this._unreadCount;};v.prototype._onOpen=function(){'use strict';if(this._scrollAreaNode){n.scrollToHeader();var w=document.documentElement;h.conditionClass(w,'hide-scroll',true);this._scrollAreaNode.style.maxHeight=w.offsetHeight-200+'px';}var x=this._getJewelCount();j.pushSoftState(this._softState);this.handleViewedContent();p.invoke('m:jewel:flyout:open',null,{jewel:this._sigil});h.conditionClass(this._getJewelElement(),'popoverOpen',true);var y=i.find(this._getJewelElement(),'div','flyout');m.focusTabbable(y);};v.prototype._onClose=function(){'use strict';if(this._scrollAreaNode){this._scrollAreaNode.style.minHeight='';h.conditionClass(document.documentElement,'hide-scroll',false);}p.invoke('m:jewel:flyout:close',null,{jewel:this._sigil});h.conditionClass(this._getJewelElement(),'popoverOpen',false);j.popSoftState(this._softState);};v.prototype.isOpen=function(){'use strict';return this._popover&&this._popover.isOpen();};v.prototype.openPopover=function(){'use strict';this._popover&&!this._popover.isOpen()&&this._popover.open();};v.prototype.reregisterListeners=function(){'use strict';var w=this.isOpen();this.clear();this._createPopover();if(w)this._popover.open();};r(v,['cleared','jewel_click']);Object.assign(v,{M_AREA_WHITE:'acw',M_AREA_LIGHTBLUE:'aclb',MARK_READ_DELAY:3000,JEWEL_NAV_NODE_ID:'mJewelNav',nextID:0});Object.assign(v.prototype,{_sigil:null,_currentJewel:null,_count:0,_popover:null});f.exports=v;}),null);
__d('FriendingSurfaceVisitationTypedLogger',['Banzai','GeneratedLoggerUtils','nullthrows'],(function a(b,c,d,e,f,g,h,i,j){'use strict';function k(){this.clear();}k.prototype.log=function(){i.log('logger:FriendingSurfaceVisitationLoggerConfig',this.$FriendingSurfaceVisitationTypedLogger1,h.BASIC);};k.prototype.logVital=function(){i.log('logger:FriendingSurfaceVisitationLoggerConfig',this.$FriendingSurfaceVisitationTypedLogger1,h.VITAL);};k.prototype.clear=function(){this.$FriendingSurfaceVisitationTypedLogger1={};return this;};k.prototype.updateData=function(m){this.$FriendingSurfaceVisitationTypedLogger1=babelHelpers['extends']({},this.$FriendingSurfaceVisitationTypedLogger1,m);return this;};k.prototype.setAppVersion=function(m){this.$FriendingSurfaceVisitationTypedLogger1.app_version=m;return this;};k.prototype.setBadgeCount=function(m){this.$FriendingSurfaceVisitationTypedLogger1.badge_count=m;return this;};k.prototype.setClientTimestamp=function(m){this.$FriendingSurfaceVisitationTypedLogger1.client_timestamp=m;return this;};k.prototype.setRawRefTab=function(m){this.$FriendingSurfaceVisitationTypedLogger1.raw_ref_tab=m;return this;};k.prototype.setRawTab=function(m){this.$FriendingSurfaceVisitationTypedLogger1.raw_tab=m;return this;};k.prototype.setRefPage=function(m){this.$FriendingSurfaceVisitationTypedLogger1.ref_page=m;return this;};k.prototype.setSurface=function(m){this.$FriendingSurfaceVisitationTypedLogger1.surface=m;return this;};k.prototype.setTargetProfileID=function(m){this.$FriendingSurfaceVisitationTypedLogger1.target_profile_id=m;return this;};k.prototype.setVC=function(m){this.$FriendingSurfaceVisitationTypedLogger1.vc=m;return this;};var l={app_version:true,badge_count:true,client_timestamp:true,raw_ref_tab:true,raw_tab:true,ref_page:true,surface:true,target_profile_id:true,vc:true};f.exports=k;}),null);
__d('MJewels',[],(function a(b,c,d,e,f,g){f.exports={REQUESTS:'requests',MESSAGES:'messages',NOTIFICATIONS:'notifications',SEARCH:'search',MORE:'more',NEWS_FEED:'news-feed',BOOKMARKS:'bookmarks',VIDEOS:'videos'};}),null);
__d('XFBConfirmationCliffTypedLogger',['Banzai','GeneratedLoggerUtils','nullthrows'],(function a(b,c,d,e,f,g,h,i,j){'use strict';function k(){this.clear();}k.prototype.log=function(){i.log('logger:XFBConfirmationCliffLoggerConfig',this.$XFBConfirmationCliffTypedLogger1,h.BASIC);};k.prototype.logVital=function(){i.log('logger:XFBConfirmationCliffLoggerConfig',this.$XFBConfirmationCliffTypedLogger1,h.VITAL);};k.prototype.clear=function(){this.$XFBConfirmationCliffTypedLogger1={};return this;};k.prototype.updateData=function(m){this.$XFBConfirmationCliffTypedLogger1=babelHelpers['extends']({},this.$XFBConfirmationCliffTypedLogger1,m);return this;};k.prototype.setCliffCaller=function(m){this.$XFBConfirmationCliffTypedLogger1.cliff_caller=m;return this;};k.prototype.setError=function(m){this.$XFBConfirmationCliffTypedLogger1.error=m;return this;};k.prototype.setSurface=function(m){this.$XFBConfirmationCliffTypedLogger1.surface=m;return this;};k.prototype.updateExtraData=function(m){m=j(i.serializeMap(m));i.checkExtraDataFieldNames(m,l);this.$XFBConfirmationCliffTypedLogger1=babelHelpers['extends']({},this.$XFBConfirmationCliffTypedLogger1,m);return this;};k.prototype.addToExtraData=function(m,n){var o={};o[m]=n;return this.updateExtraData(o);};var l={cliff_caller:true,error:true,surface:true};f.exports=k;}),null);
__d("XMessagesJewelContentController",["XController"],(function a(b,c,d,e,f,g){f.exports=c("XController").create("\/mobile\/messages\/jewel\/content\/",{spinner_id:{type:"String",required:true}});}),null);
__d("XNotificationJewelContentController",["XController"],(function a(b,c,d,e,f,g){f.exports=c("XController").create("\/mobile\/notifications\/jewel\/content\/",{spinner_id:{type:"String",required:true}});}),null);
__d('MJewelSet',['Banzai','BanzaiLogger','ChannelEventType','CSS','DOM','EventListener','FriendingSurfaceVisitationTypedLogger','MarauderLogger','MessagingEvent','MFriendRequestIHEventLogger','MInitJewelCounts','MJewel','MJewels','MLegacyDataStore','MLogState','MPymkFunnelLogger','MRequest','MTouchChannelManager','MTouchDisplayNoneTestGK','MURI','MViewport','Popover','ScriptPath','Stratcom','XFBConfirmationCliffTypedLogger','XMessagesJewelContentController','XNotificationJewelContentController','fbt','throttle'],(function a(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja){var ka={_viewerID:null,_requestsJewel:null,_messagesJewel:null,_notificationsJewel:null,_unseenNotificationIds:{},_unseenThreadIDs:{},_unreadThreadIDs:{},_jewelClickLogListener:null,_messengerCliff:false,_haveInitializedJewels:false,_pymkAndRequestImpressionLogged:false,MSG_ID_PREFIX:'msg_',OTHER_USER_FBID_PREFIX:'other_user_fbid_',THREAD_FBID_PREFIX:'thread_fbid_',NOTIF_ID_PREFIX:'notif_',JEWEL_NAV_NODE_ID:'mJewelNav',JEWEL_NAV_CACHE_KEY:'mJewelNavKey',JEWEL_MSG_LIST:'mJewelMsgThreadContents',_lazyLoadNotificationsReq:null,_lazyLoadMessagesReq:null,_hasCombinedTab:false,_diodeBadgeableQPCount:0,createJewels:function la(ma){if(ma.showRequests){ka._requestsJewel=new s('requests',{pos:v.CLICK_POSITION_REQUESTS_FLYOUT,softState:t.REQUESTS,jewelRedirect:ma.shouldRedirectRequestsJewel},'friends_jewel_module');ka._requestsJewel.listen('cleared',ka._markRequestsRead);ka._requestsJewel.listen('jewel_click',ka._logRequestsJewelClick);}if(ma.hasCombinedTab)ka._hasCombinedTab=true;ka._messagesJewel=new s('messages',{contentsSigil:ka.JEWEL_MSG_LIST,pos:v.CLICK_POSITION_MESSAGES_FLYOUT,softState:t.MESSAGES},'messages_jewel_module');ka._messagesJewel.listen('cleared',ka._markMessagesRead);ka._notificationsJewel=new s('notifications',{pos:v.CLICK_POSITION_NOTIFICATIONS_FLYOUT,softState:t.NOTIFICATIONS},'notifications_jewel_module');ka._notificationsJewel.listen('cleared',ka._markNotificationsSeen);ka._jewelClickLogListener=ka._notificationsJewel.listen('jewel_click',ka._logNotificationJewelClick);ea.listen('m:jewel:flyout:open',null,ka._onJewelOpen);},openMessageJewel:function la(){ka._messagesJewel.openPopover();},setMessengerCliff:function la(ma,na,oa){ka._messengerCliff=ma;},setMessengerCliffShouldLog:function la(ma,na){},markFriendRequestsSeen:function la(event){if(ka._requestsJewel===null)return;ka._requestsJewel.setCount(0);},updateFriendRequests:function la(event){if(ka._requestsJewel===null)return;if(ka._requestsJewel.isOpen())return;var ma=new x('/ajax/mobile/friends/jewel/requests_markup');ma.send();},onAfterUpdateFriendRequests:function la(ma){if(ka._requestsJewel===null)return;ka._setJewelCount(ka._requestsJewel,ma,ka._markRequestsRead);ca.getInstance('reqs_flyout').refreshConstraints();if(ka._requestsJewel.isOpen()){var na=ka._requestsJewel._getContentsElement();ka._logPymkAndRequestImpression(na);}},onCombinedTabAsyncLoad:function la(){if(ka._notificationsJewel&&ka._notificationsJewel.isOpen()){var ma=ka._notificationsJewel._getContentsElement();ka._logPymkAndRequestImpression(ma);}},_logPymkAndRequestImpression:function la(ma){if(ka._pymkAndRequestImpressionLogged)return;ka._pymkAndRequestImpressionLogged=true;var na=l.scry(ma,'div','undoable-action');for(var oa=0;oa<na.length;oa++){var pa=na[oa].getAttribute('data-pymk-id');if(pa){var qa=na[oa].getAttribute('data-signature');w.logImpression(pa,qa,'mobile_jewel');}else{var ra=u.get(na[oa]).userid;o.log('request_seen','friend_request_waterfall',{request_id:ra,request_location:'requests_jewel'});q.logImpression(ra?ra.toString():null);}}},refreshNotificationsConstraints:function la(){ca.getInstance('notifications_flyout').refreshConstraints();},refreshNotificationsConstraintsOnImageLoad:function la(){var ma=document.getElementById('notifications_flyout');if(!ma)return;ka.refreshNotificationsConstraints();var na=ja(ka.refreshNotificationsConstraints,500);l.scry(ma,'img','notif_thumb').forEach(function(oa){var pa=m.listen(oa,'load',function(){pa.remove();na();});});},refreshMessagesConstraints:function la(){ca.getInstance('messages_flyout').refreshConstraints();},updateNotification:function la(event){var ma=event.getData();if(ma&&ma.data){if(ma.data.type==='friend_confirmed')return;if(!ka._notificationsJewel.isOpen()&&!ka._unseenNotificationIds[ma.data.alert_id])ka._notificationsJewel.setCount(ma.data.unread+ka._notificationsJewel.getCount());ka._notificationsJewel.removeMenuContent(ka._getNotifNodeID(ma.data.alert_id));ka._unseenNotificationIds[ma.data.alert_id]=true;if(ka._notificationsJewel.isOpen())ka._markNotificationsSeen();ka._loadNotificationJewelContent();}},updateUnseenNotificationIds:function la(event){var ma=event.getData();if(!ma)return;var na=event.getType()=='notifications_read';if(ma.alert_ids){var oa=0;for(var pa=0;pa<ma.alert_ids.length;pa++)if(ka._unseenNotificationIds[ma.alert_ids[pa]]){delete ka._unseenNotificationIds[ma.alert_ids[pa]];na&&ka._notificationsJewel.updateMenuColor(ka._getNotifNodeID(ma.alert_ids[pa]),true,false);oa++;}var qa=ka._notificationsJewel.getCount();ka._notificationsJewel.setCount(qa-oa);}else{ka._notificationsJewel.setCount(0);if(na)for(var ra in ka._unseenNotificationIds)ka._notificationsJewel.updateMenuColor(ka._getNotifNodeID(ra),true,false);ka._unseenNotificationIds={};}},updateMessageCounts:function la(event){var ma=event.getData();if(!ma)return;if(ma.event===p.READ&&ma.message.folder==='inbox'){var na=ma.message.thread_fbid||ma.message.other_user_fbid;delete ka._unseenThreadIDs[na];delete ka._unreadThreadIDs[na];}else if(ma.event===p.UNREAD&&ma.message.folder==='inbox'){var oa=ma.message.thread_fbid||ma.message.other_user_fbid;ka._unreadThreadIDs[oa]=1;}else if(ma.event===p.MARK_ALL_READ&&ma.message.folder==='inbox'){ka._unreadThreadIDs={};ka._unseenThreadIDs={};}else if(ma.event===p.MARK_ALL_SEEN&&ma.message.folder==='inbox'){ka._unseenThreadIDs={};}else if(ma.parsedPayload&&ma.folder==='inbox'){var pa=ma.parsedPayload;if(!ka._viewerIsAParticipant(ka._viewerID,pa)||pa.isUnread()===false||ma.message.is_muted)return;var qa=pa.getThreadFBID()||pa.getOtherUserFBID();ka._unseenThreadIDs[qa]=1;ka._unreadThreadIDs[qa]=1;}else return;var ra=Object.keys(ka._unseenThreadIDs).length,sa=Object.keys(ka._unreadThreadIDs).length;if(!ka._messagesJewel.isOpen()&&ra!==ka._messagesJewel.getCount())ka._messagesJewel.setCount(ra+ka._diodeBadgeableQPCount);var ta=sa>0?ia._("Messages ({unread_message_count})",[ia.param('unread_message_count',sa)]):ia._("Messages");ka._messagesJewel.setHeaderText('messages_jewel_header_text',ta);},updateMessage:function la(event){var ma=event.getData();if(!ma)return;if(ma.parsedPayload){var na=ma.parsedPayload;if(na.getFolder()!=='inbox'||!ka._viewerIsAParticipant(ka._viewerID,na))return;if(ka._messagesJewel.isInitialized()){ka._messagesJewel.removeMenuContent(ka._getMessageNodeID(na.getOtherUserFBID(),na.getThreadFBID()));if(ka._messagesJewel.isOpen())ka._markMessagesRead();}ka._loadMessagesJewelContent();}else if(ma.event===p.READ&&ma.is_sync)ka._messagesJewel.updateMenuColor(ka._getMessageNodeID(ma.message.other_user_fbid,ma.message.thread_fbid),true,false);},_getMessageNodeID:function la(ma,na){ma=ma?ma:'';na=na?na:'';return ka.MSG_ID_PREFIX+ka.OTHER_USER_FBID_PREFIX+ma+ka.THREAD_FBID_PREFIX+na;},_getNotifNodeID:function la(ma){return ka.NOTIF_ID_PREFIX+ma;},_markRequestsRead:function la(){ea.invoke('m_requests_jewel_mark_read');var ma=new x(new aa('/a/jewel_requests_read.php').toString());ma.send();},_markMessagesRead:function la(){var ma=new x(new aa('/a/jewel_messages_read.php').toString());ma.send();},_markNotificationsSeen:function la(){if(ka._jewelClickLogListener){ka._jewelClickLogListener.remove();ka._jewelClickLogListener=null;}if(ka._hasCombinedTab)ka._markRequestsRead();var ma=ka._unseenNotificationIds;ka._unseenNotificationIds={};var na=[];for(var oa in ma)na.push(oa);var pa=new x(new aa('/a/jewel_notifications_read.php').toString());pa.addData({ids:na,count:na.length,seen:true});pa.send();},_onJewelOpen:function la(event){var ma=event.getData();if(ma&&ma.jewel)if(ma.jewel==='notifications'){ka._loadNotificationJewelContent();}else if(ma.jewel==='messages'){if(ka._messengerCliff)new fa().setSurface('messenger_seen').log();var na=ka._messagesJewel.getCount()-ka._diodeBadgeableQPCount;ka._messagesJewel.setCount(na);ka._diodeBadgeableQPCount=0;ka._loadMessagesJewelContent();}da.set('topbar_'+ma.jewel);},_loadNotificationJewelContent:function la(){var ma=ka._notificationsJewel._getContentsElement(),na='notifications-flyout-loading';if(ea.hasSigil(ma,na)){var oa=ha.getURIBuilder().setString('spinner_id',ma.getAttribute('id')).getURI();if(!ka._lazyLoadNotificationsReq){ka._lazyLoadNotificationsReq=new x(oa);ka._lazyLoadNotificationsReq.listen('finally',function(){ka._lazyLoadNotificationsReq=null;});ka._lazyLoadNotificationsReq.send();}}},_loadMessagesJewelContent:function la(){var ma=ka._messagesJewel._getJewelElement(),na='messages-flyout-loading',oa=l.scry(ma,'*',na);if(oa.length>0){var pa=ga.getURIBuilder().setString('spinner_id',oa[0].getAttribute('id')).getURI();if(!ka._lazyLoadMessagesReq){ka._lazyLoadMessagesReq=new x(pa);ka._lazyLoadMessagesReq.listen('finally',function(){ka._lazyLoadMessagesReq=null;});ka._lazyLoadMessagesReq.send();}}},_logNotificationJewelClick:function la(){if(ka._jewelClickLogListener){ka._jewelClickLogListener.remove();ka._jewelClickLogListener=null;}if(ka._hasCombinedTab){var ma=ka._notificationsJewel._getContentsElement();ka._logRequestsImpessions(ma);if(ka._notificationsJewel.isOpen())if(!ea.hasSigil(ma,'notifications-flyout-loading'))ka._logPymkAndRequestImpression(ma);}new x('/a/jewel_notifications_log.php').addData({click_type:'jewel_click',count:ka._notificationsJewel.getCount()}).send();},_logRequestsJewelClick:function la(){var ma=ka._requestsJewel._getContentsElement();ka._logRequestsImpessions(ma);new n().setSurface('jewel').setBadgeCount(ka._requestsJewel.getCount()).log();if(ka._requestsJewel.isOpen())if(ea.hasSigil(ma,'requests-flyout-loading')){new x('/ajax/mobile/friends/jewel/requests_markup').send();}else{var na=ka._requestsJewel._getContentsElement();ka._logPymkAndRequestImpression(na);}},_logRequestsImpessions:function la(ma){if(!ma)return;var na=l.scry(ma,'div','attachment'),oa=[];for(var pa=0;pa<na.length;pa++){var qa=na[pa].getAttribute('id');if(qa&&qa.startsWith('m_jewel_req_'))oa=oa.concat(qa.replace('m_jewel_req_',''));}if(oa.length){var ra=new x('/friends/requests/log_impressions');ra.setMethod('POST');ra.addData({ids:oa.join(','),ref:'m_jewel'});ra.send();}},_viewerIsAParticipant:function la(ma,na){if(!na.getParticipantIDs())return false;if(na.getParticipantIDs().indexOf(ma)>-1)return true;return na.getParticipantIDs().indexOf(ma.toString())>-1;},_initJewelCount:function la(ma,na,oa){ma.setDuringInit(true);ma.reregisterListeners();ka._setJewelCount(ma,na,oa);ma.setDuringInit(false);},_setJewelCount:function la(ma,na,oa){if(!ma.isOpen()){ma.setCount(na);}else if(na)oa();},_initJewelCounts:function la(event){var ma=event.getData();ka.initJewels(null,null);if(ma.viewer_id)ka._viewerID=ma.viewer_id;if(ma.unread_notification_ids)ka._unseenNotificationIds=ma.unread_notification_ids||{};if(ma.unseen_thread_ids)ka._unseenThreadIDs=ma.unseen_thread_ids.reduce(function(pa,qa){pa[qa]=1;return pa;},{});if(ma.unread_thread_ids)ka._unreadThreadIDs=ma.unread_thread_ids.reduce(function(pa,qa){pa[qa]=1;return pa;},{});if(ma.request_count&&ka._requestsJewel)ka._initJewelCount(ka._requestsJewel,ma.request_count,ka._markRequestsRead);if(ma.unseen_thread_ids||ma.diode_badgeable_qp_count){var na=ma.unseen_thread_ids?ma.unseen_thread_ids.length:0,oa=na+(ma.diode_badgeable_qp_count?ma.diode_badgeable_qp_count:0);if(ma.diode_badgeable_qp_count)ka._diodeBadgeableQPCount=ma.diode_badgeable_qp_count;ka._initJewelCount(ka._messagesJewel,oa,ka._markMessagesRead);}if(ma.notification_count)ka._initJewelCount(ka._notificationsJewel,ma.notification_count,ka._markNotificationsSeen);},initJewels:function la(ma,na){if(ka._haveInitializedJewels)return;ka._haveInitializedJewels=true;y.initialize();ka.createJewels(na||{});if(ka._requestsJewel){if(!ka._friendRequestAddListener)ka._friendRequestAddListener=ea.listen('jewel_requests_add',null,ka.updateFriendRequests);if(!ka._friendRequestRemoveListener)ka._friendRequestRemoveListener=ea.listen('jewel_requests_remove_old',null,ka.updateFriendRequests);if(!ka._friendAcceptedListener)ka._friendAcceptedListener=ea.listen('jewel_friending_notifs',null,ka.updateFriendRequests);if(!ka._friendRequestSeenListener)ka._friendRequestSeenListener=ea.listen('friend_requests_seen',null,ka.markFriendRequestsSeen);}if(!ka._notificationListener)ka._notificationListener=ea.listen('m_notification',null,ka.updateNotification);if(!ka._notificationRefreshListener)ka._notificationRefreshListener=ea.listen('m:jewel-set:notifications-jewel:refresh-flyout',null,ka.refreshNotificationsConstraints);if(!ka._messageListener)ka._messageListener=ea.listen(j.MESSAGE,null,ka.updateMessage);if(!ka._messageCountListener)ka._messageCountListener=ea.listen(j.MESSAGE,null,ka.updateMessageCounts);if(!ka._notifReadListener)ka._notifReadListener=ea.listen('notifications_read',null,ka.updateUnseenNotificationIds);if(!ka._notifSeenListener)ka._notifSeenListener=ea.listen('notifications_seen',null,ka.updateUnseenNotificationIds);if(!ka._friendRequestResponseListener)ka._friendRequestResponseListener=ea.listen('m:requests:refresh',null,function(){var oa=ka._hasCombinedTab?'notifications_flyout':'reqs_flyout';ca.getInstance(oa).refreshConstraints();});if(!ka._orientationChangeListener)ka._orientationChangeListener=ea.listen('m:viewport:orientation-change',null,ka._onOrientationChange);this._initMTouchDisplayNoneTest();},_initMTouchDisplayNoneTest:function la(){if(z&&z.gk_check)k.addClass(document.body,'MTouchDisplayNoneTestGK');},_onOrientationChange:function la(){setTimeout(function(){var ma=ca._activePopover;if(!ma)return;if(ba.getHeight()+'px'!==ma.flyout.style.minHeight)ma.refreshConstraints();},800);}};(function(){ea.listen('m:jewels:init-counts',null,ka._initJewelCounts);r.replayMissedEvents();})();f.exports=ka;}),null);
__d('MJewelThreads',['Bootloader','ChannelEventType','MessagingEvent','Stratcom'],(function a(b,c,d,e,f,g,h,i,j,k){'use strict';function l(m){this.$MJewelThreads1=m;this.$MJewelThreads2=[];this.$MJewelThreads3=false;this.$MJewelThreads4=false;k.listen(i.MESSAGE,null,this.onMessageEvent.bind(this));}l.prototype.getThreads=function(){return this.$MJewelThreads2;};l.prototype.registerListeners=function(){k.listen('click','live-threads',this.onThreadClick.bind(this));k.listen('m:jewel:flyout:open',null,this.onJewelOpen.bind(this));};l.prototype.onJewelOpen=function(event){var m=event.getData(),n=m&&m.jewel&&m.jewel==='messages';if(n&&this.$MJewelThreads4)this.updateUI();};l.prototype.onThreadClick=function(event){var m=event.getNode('live-thread');if(!m)return;this.setThreadReadStatus(m.getAttribute('data-fbid'),m.getAttribute('data-canonical')==='true',true);this.updateUI();};l.prototype.onMessageEvent=function(event){var m=event.getData();if(m.parsedPayload){var n=m.parsedPayload;if(n.getFolder()!=='inbox')return;if(!this.$MJewelThreads3){this.$MJewelThreads3=true;this.registerListeners();}this.addThread(n);}else if(Object.prototype.hasOwnProperty.call(m,'mark_as_read')){m.other_user_fbids.forEach(function(q){this.setThreadReadStatus(q.toString(),true,m.mark_as_read);}.bind(this));m.thread_fbids.forEach(function(q){this.setThreadReadStatus(q.toString(),false,m.mark_as_read);}.bind(this));this.updateUI();}else if(m.event===j.READ&&m.is_sync){var o=!!m.message.other_user_fbid,p=o?m.message.other_user_fbid:m.message.thread_fbid;this.setThreadReadStatus(p,o,true);this.updateUI();}};l.prototype.addThread=function(m){this.$MJewelThreads2=this.$MJewelThreads2.filter(function(n){var o=n.isCanonicalThread()?n.getOtherUserFBID():n.getThreadFBID();return !this.isSameThread(o,m.isCanonicalThread(),m);}.bind(this));m.unread=m.isUnread();this.$MJewelThreads2.push(m);this.$MJewelThreads4=true;this.updateThreadImage(m);};l.prototype.updateThreadImage=function(m){h.loadModules(["MMessagesThreadMetadataCache","MShortProfiles"],function(n,o){if(m.hasThreadImage()){n.get(m.getThreadFBID(),function(q){m.image_src=q.image_src;this.updateUI();}.bind(this));}else{var p=m.isCanonicalThread()?m.getOtherUserFBID():m.getAuthorFBID();o.get(p,function(q){m.image_src=q.mThumbSrcSmall;this.updateUI();}.bind(this));}}.bind(this),'MJewelThreads');};l.prototype.setThreadReadStatus=function(m,n,o){this.$MJewelThreads2.forEach(function(p){if(this.isSameThread(m,n,p)){if(p.unread==o)this.$MJewelThreads4=true;p.unread=!o;}}.bind(this));};l.prototype.isSameThread=function(m,n,o){var p=n?o.getOtherUserFBID():o.getThreadFBID();return m==p;};l.prototype.updateUI=function(){if(!this.$MJewelThreads3||!this.$MJewelThreads4)return;h.loadModules(["React","ReactDOM","MJewelThreadList.react","Popover"],function(m,n,o,p){if(!p.getInstance('messages_flyout').isOpen())return;var q={threads:this.$MJewelThreads2};n.render(m.createElement(o,q),this.$MJewelThreads1);p.getInstance('messages_flyout').refreshConstraints();this.$MJewelThreads4=false;}.bind(this),'MJewelThreads');};f.exports=l;}),null);
__d('MQuickPromotion',['DOM','Stratcom'],(function a(b,c,d,e,f,g,h,i){var j=false,k=function l(){if(j)return;j=true;var m='m-promo-close';function n(event){var o=event.getNode('m-promo');h.hide(o);}i.listen('click',m,n);};g.main=k;}),null);